# Testing PhonePe Webhook in Postman

## Overview

You can test the webhook endpoint directly in Postman by simulating a PhonePe webhook request.

---

## Step 1: Create a Test Order First

Before testing the webhook, you need an order ID. Create a test order:

```http
POST http://localhost:3000/orders
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "listing_id": "your-listing-uuid",
  "meeting_location": "Test Location"
}
```

**Save the `order_id` from the response** - you'll need it for the webhook test.

---

## Step 2: Test Webhook Endpoint in Postman

### Request Setup

**Method:** `POST`

**URL:**
```
http://localhost:3000/orders/webhook
```

**Or with ngrok (if testing from external):**
```
https://degradable-precedented-joya.ngrok-free.dev/orders/webhook
```

### Headers

Add these headers:

| Key | Value | Description |
|-----|-------|-------------|
| `Content-Type` | `application/json` | Required |
| `x-verify` | `test_signature_123###1` | PhonePe signature (for testing) |
| `authorization` | `test_auth_header` | Authorization header (for SDK validation) |

**Note:** For actual PhonePe webhooks, these headers are generated by PhonePe. For testing, we use placeholder values.

### Body (JSON)

Use this example payload structure:

```json
{
  "code": "PAYMENT_SUCCESS",
  "message": "Payment successful",
  "data": {
    "merchantId": "M232G4O6KU7K2_2601012107",
    "merchantTransactionId": "YOUR_ORDER_ID_HERE",
    "transactionId": "TXN123456789",
    "amount": 55825,
    "state": "COMPLETED",
    "responseCode": "PAYMENT_SUCCESS",
    "paymentInstrument": {
      "type": "UPI"
    }
  }
}
```

**Replace `YOUR_ORDER_ID_HERE`** with the actual order_id from Step 1.

---

## Step 3: Example Test Scenarios

### Scenario 1: Successful Payment Webhook

**Headers:**
```
Content-Type: application/json
x-verify: test_signature_123###1
authorization: test_auth_header
```

**Body:**
```json
{
  "code": "PAYMENT_SUCCESS",
  "message": "Payment successful",
  "data": {
    "merchantId": "M232G4O6KU7K2_2601012107",
    "merchantTransactionId": "550e8400-e29b-41d4-a716-446655440000",
    "transactionId": "TXN123456789",
    "amount": 55825,
    "state": "COMPLETED",
    "responseCode": "PAYMENT_SUCCESS",
    "paymentInstrument": {
      "type": "UPI"
    }
  }
}
```

**Expected Response (200 OK):**
```json
{
  "success": true,
  "order_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**What Happens:**
- Order status changes from `pending` to `escrowed`
- `payment_id` is set to `TXN123456789`
- Server logs: `✅ Webhook validated successfully using SDK`

---

### Scenario 2: Failed Payment Webhook

**Body:**
```json
{
  "code": "PAYMENT_FAILED",
  "message": "Payment failed",
  "data": {
    "merchantId": "M232G4O6KU7K2_2601012107",
    "merchantTransactionId": "550e8400-e29b-41d4-a716-446655440000",
    "transactionId": "TXN123456789",
    "amount": 55825,
    "state": "FAILED",
    "responseCode": "PAYMENT_FAILED",
    "paymentInstrument": {
      "type": "UPI"
    }
  }
}
```

**Expected Response (200 OK):**
```json
{
  "success": false,
  "order_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**What Happens:**
- Order status remains `pending`
- `payment_id` is still set (for tracking)

---

## Step 4: Verify Order Status Changed

After sending a successful webhook, check the order status:

```http
GET http://localhost:3000/orders/{order_id}
Authorization: Bearer YOUR_TOKEN
```

**Expected Response:**
```json
{
  "order_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "escrowed",  // ✅ Changed from "pending"
  "payment_id": "TXN123456789",  // ✅ Set from webhook
  ...
}
```

---

## Step 5: Postman Collection Setup

### Create a New Request in Postman

1. **Create Request:**
   - Name: `Test PhonePe Webhook - Success`
   - Method: `POST`
   - URL: `http://localhost:3000/orders/webhook`

2. **Add Headers:**
   - `Content-Type`: `application/json`
   - `x-verify`: `test_signature_123###1`
   - `authorization`: `test_auth_header`

3. **Add Body:**
   - Select `raw` and `JSON`
   - Paste the example payload (update `merchantTransactionId`)

4. **Save Request**

### Create Environment Variables

Create a Postman environment with:

| Variable | Initial Value | Current Value |
|----------|---------------|---------------|
| `base_url` | `http://localhost:3000` | `http://localhost:3000` |
| `order_id` | `your-order-id` | (update after creating order) |
| `ngrok_url` | `https://degradable-precedented-joya.ngrok-free.dev` | (your ngrok URL) |

Then use in URL:
```
{{base_url}}/orders/webhook
```

Or with ngrok:
```
{{ngrok_url}}/orders/webhook
```

---

## Complete Test Flow

### 1. Create Order
```http
POST {{base_url}}/orders
Authorization: Bearer {{token}}
Body: { "listing_id": "...", "meeting_location": "Test" }
```
**Save:** `order_id` from response

### 2. Send Webhook (Success)
```http
POST {{base_url}}/orders/webhook
Headers:
  Content-Type: application/json
  x-verify: test_signature_123###1
  authorization: test_auth_header
Body:
{
  "code": "PAYMENT_SUCCESS",
  "message": "Payment successful",
  "data": {
    "merchantId": "M232G4O6KU7K2_2601012107",
    "merchantTransactionId": "{{order_id}}",
    "transactionId": "TXN123456789",
    "amount": 55825,
    "state": "COMPLETED",
    "responseCode": "PAYMENT_SUCCESS",
    "paymentInstrument": { "type": "UPI" }
  }
}
```

### 3. Verify Order Status
```http
GET {{base_url}}/orders/{{order_id}}
Authorization: Bearer {{token}}
```
**Check:** `status` should be `"escrowed"`

---

## Expected Server Logs

### Successful Validation:
```
✅ Webhook validated successfully using SDK
```

### If Credentials Not Set:
```
⚠️  Webhook username/password not set. Using basic signature verification.
```

### If Validation Fails:
```
❌ Webhook validation failed: [error details]
```

---

## Troubleshooting

### "Invalid webhook credentials or signature"
- **Cause:** Webhook validation failed
- **Solution:** 
  - Check `PHONEPE_WEBHOOK_USERNAME` and `PHONEPE_WEBHOOK_PASSWORD` in `.env`
  - Restart server after updating `.env`
  - For testing, the basic validation should still work

### "Order not found"
- **Cause:** `merchantTransactionId` doesn't match any order
- **Solution:** Use a valid `order_id` from an actual order

### "Missing merchantTransactionId"
- **Cause:** Payload structure is incorrect
- **Solution:** Ensure `data.merchantTransactionId` exists in payload

---

## Testing with Actual PhonePe Webhook

When PhonePe sends a real webhook:

1. **Check ngrok interface:** `http://127.0.0.1:4040`
   - See the actual request from PhonePe
   - Copy the exact payload structure
   - Use it as a template for Postman tests

2. **Check server logs:**
   - See validation messages
   - See any errors

3. **Verify order updated:**
   - Check order status changed to `escrowed`
   - Check `payment_id` is set

---

## Quick Test Checklist

- [ ] Order created (have `order_id`)
- [ ] Webhook endpoint URL correct
- [ ] Headers added (`x-verify`, `authorization`)
- [ ] Body payload includes `merchantTransactionId` matching `order_id`
- [ ] `state` is `"COMPLETED"` and `responseCode` is `"PAYMENT_SUCCESS"` for success
- [ ] Server logs show validation success
- [ ] Order status changed to `escrowed` after webhook

---

## Example Postman Request

**Complete Request:**
```
POST http://localhost:3000/orders/webhook

Headers:
  Content-Type: application/json
  x-verify: test_signature_123###1
  authorization: test_auth_header

Body (raw JSON):
{
  "code": "PAYMENT_SUCCESS",
  "message": "Payment successful",
  "data": {
    "merchantId": "M232G4O6KU7K2_2601012107",
    "merchantTransactionId": "550e8400-e29b-41d4-a716-446655440000",
    "transactionId": "TXN123456789",
    "amount": 55825,
    "state": "COMPLETED",
    "responseCode": "PAYMENT_SUCCESS",
    "paymentInstrument": {
      "type": "UPI"
    }
  }
}
```

**Expected Response:**
```json
{
  "success": true,
  "order_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

---

**Ready to test!** Follow the steps above to test the webhook in Postman.




